
{% extends 'storefront/base.html' %}

{% block title %}{{item.name}}{% endblock %}

{%block content %}
<div class="itemcontainer"> 
    {% if user_loggedin %}
        <div id="form-container">
            <form id="openai-form">
                <label for="prompt-input">Enter your prompt:</label><br>
                <textarea  id="prompt-input" rows="5" cols="50"></textarea><br>
                <button type="submit">Generate Response</button>
            </form>
            <div id="openai-response">response</div> 
        </div>
        <script>
            document.getElementById('openai-form').addEventListener('submit', async function(event) {
                event.preventDefault();
                const prompt = document.getElementById('prompt-input').value + "!@#$%^&*()[" + "{{ product_data }}" + "]";
                console.log(prompt)
                const responseDiv = document.getElementById('openai-response');
                responseDiv.innerHTML = 'Generating...';

                try {
                    const formData = new FormData();
                    formData.append('prompt', prompt);

                    const response = await fetch('/openai-api/', {
                        method: 'POST',
                        body: formData,
                        // csrf 
                        // headers: { 'X-CSRFToken': getCookie('csrftoken') }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.response) {
                        responseDiv.innerHTML = data.response;
                    } else if (data.error) {
                        responseDiv.innerHTML = `Error: ${data.error}`;
                    }
                } catch (error) {
                    console.error('Fetch error:', error);
                    responseDiv.innerHTML = `An error occurred: ${error.message}`;
                }
            });

            // for csrf varification later
            /*
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                        }
                    }
                }
                return cookieValue;
            }
            */
        </script>
    {% endif %}

    <div class="itemimgcontainer">
        <img src="{{product.image.url}}" class="itemimg">
    </div>

    <div class="infocontainer">
        <h1 class="infohead">{{ product.name}}</h1>
        <p class="infotxt"><strong>Price:</strong> ${{product.price}}</p>
        <p class="infotxt"><strong>Seller:</strong> {{product.created_by}}</p>
        {% if product.description %}
            <p class="infotxt"><strong class="infoHead">Description:</strong><br>
                 {{product.description}}
            </p>
        {% endif %}
        <a href="{% url 'storefront:checkout' product.id %}"><button class="purchase">Purchase</button></a>
        <a href="{% url 'cart:add' product.id %}"><button class="purchase">Add to Cart</button></a>
        {% if request.user == product.created_by %}
            <div class="specify button">
                <a href="{% url 'product:editproduct' product.id %}"><button class='detail-edit-button'>Edit Item</button></a>
                <a href="{% url 'product:deleteproduct' product.id %}"><button class='detail-delete-button'>Delete Item</button></a>
                <p>You created this item!</p><br>
            </div>
        {% endif %}
    </div>
</div>
<h2 class="rlheader">Related Items</h2>
<div class="rlcontainer">
    {% for product in related_product %}
    <div class="rlcard">
            <div class='card-content'>
                <a class='rl-links' href="{% url 'product:productdetail' product.id %}">
                    <div class='itemimgcontainer'>
                        <img src="{{ product.image.url}}" class="rlimg">
                    </div>
                    <div class="rlinfocontainer">
                        <h2 class="rlinfotxt">{{ product.name }}</h2>
                        <p class="rlinfotxt">Price : {{product.price }}</p>
                    </div>
                </a>
            </div>
    </div>
    {% endfor %} 
</div>
{% endblock %}
